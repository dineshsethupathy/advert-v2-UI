<div class="store-view-container" *ngIf="!loading && storeViewData">
    <!-- Page Header Section -->
    <div class="content-header">
        <div class="header-content">
            <div class="header-left">
                <button class="back-btn" (click)="goBack()">
                    <span class="material-icons">arrow_back</span>
                </button>
                <div class="header-info">
                    <h2 class="page-title">{{ storeViewData.storeAssignment.storeName }}</h2>
                    <p class="page-description">{{ storeViewData.assignment.name }}</p>
                </div>
            </div>
            <div class="header-status">
                <div class="status-item">
                    <span class="label">Vendor Status:</span>
                    <span class="status-chip"
                        [class]="'status-' + getVendorStatusColor(storeViewData.storeAssignment.vendorWorkStatus)">
                        {{ storeViewData.storeAssignment.vendorWorkStatus }}
                    </span>
                </div>
                <div class="status-item">
                    <span class="label">Approval Status:</span>
                    <span class="status-chip"
                        [class]="'status-' + getApprovalStatusColor(storeViewData.storeAssignment.approvalStatus)">
                        {{ storeViewData.storeAssignment.approvalStatus }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Store Details Card -->
    <div class="details-card">
        <div class="card-header">
            <h3 class="card-title">Store Information</h3>
        </div>
        <div class="details-table-container">
            <table class="details-table">
                <tbody>
                    <tr>
                        <td class="detail-label">Store Name:</td>
                        <td class="detail-value">{{ storeViewData.storeAssignment.storeName }}</td>
                        <td class="detail-label">SAP ID:</td>
                        <td class="detail-value">{{ storeViewData.storeAssignment.sapId }}</td>
                        <td class="detail-label">Address:</td>
                        <td class="detail-value">{{ storeViewData.storeAssignment.storeAddress || 'N/A' }}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Region:</td>
                        <td class="detail-value">{{ storeViewData.storeAssignment.regionName || 'N/A' }}</td>
                        <td class="detail-label">Phone:</td>
                        <td class="detail-value">{{ storeViewData.storeAssignment.storePhoneNumber || 'N/A' }}</td>
                        <td class="detail-label">Vendor:</td>
                        <td class="detail-value">{{ storeViewData.assignment.vendorName }}</td>
                    </tr>
                    <tr>
                        <td class="detail-label">Workflow:</td>
                        <td class="detail-value">{{ storeViewData.assignment.workflowName }}</td>
                        <td class="detail-label">Assigned By:</td>
                        <td class="detail-value">{{ storeViewData.assignment.assignedByName }}</td>
                        <td class="detail-label">Assigned Date:</td>
                        <td class="detail-value">{{ formatDate(storeViewData.assignment.assignedDate) }}</td>
                    </tr>
                    <tr *ngIf="storeViewData.storeAssignment.gpsLocation">
                        <td class="detail-value gps-location-cell" colspan="6">
                            <div class="gps-info-display"
                                (click)="openGoogleMaps(storeViewData.storeAssignment.gpsLocation)">
                                <span class="gps-icon">
                                    <span class="material-icons">open_in_new</span>
                                </span>
                                <span class="gps-address">{{ getGpsAddress(storeViewData.storeAssignment.gpsLocation)
                                    }}</span>
                                <span class="gps-coordinates"
                                    *ngIf="getGpsCoordinates(storeViewData.storeAssignment.gpsLocation)">
                                    üìç {{
                                    formatCoordinates(getGpsCoordinates(storeViewData.storeAssignment.gpsLocation)) }}
                                </span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Images Section -->
    <div class="images-card" *ngIf="hasImages()">
        <div class="card-header">
            <h3 class="card-title">Execution Images</h3>
        </div>
        <div class="images-grid">
            <div class="image-item" *ngIf="storeViewData.storeAssignment.bannerImageUrl">
                <h4>Banner Image</h4>
                <div class="image-container">
                    <div class="image-loading" *ngIf="!bannerImageLoaded">
                        <l-tail-chase size="40" speed="1" color="#006fcf"></l-tail-chase>
                    </div>
                    <img [src]="storeViewData.storeAssignment.bannerImageUrl" alt="Banner Image"
                        (load)="onBannerImageLoad()" (error)="onBannerImageError()" [class.hidden]="!bannerImageLoaded"
                        [class.loaded]="bannerImageLoaded"
                        (click)="openImageModal(storeViewData.storeAssignment.bannerImageUrl)">
                </div>
            </div>
            <div class="image-item" *ngIf="storeViewData.storeAssignment.beforeExecutionImageUrl">
                <h4>Before Execution</h4>
                <div class="image-container">
                    <div class="image-loading" *ngIf="!beforeImageLoaded">
                        <l-tail-chase size="40" speed="1" color="#006fcf"></l-tail-chase>
                    </div>
                    <img [src]="storeViewData.storeAssignment.beforeExecutionImageUrl" alt="Before Execution"
                        (load)="onBeforeImageLoad()" (error)="onBeforeImageError()" [class.hidden]="!beforeImageLoaded"
                        [class.loaded]="beforeImageLoaded"
                        (click)="openImageModal(storeViewData.storeAssignment.beforeExecutionImageUrl)">
                </div>
                <p class="image-date" *ngIf="storeViewData.storeAssignment.beforeExecutionDate">
                    {{ formatDateOnly(storeViewData.storeAssignment.beforeExecutionDate) }}
                </p>
            </div>
            <div class="image-item" *ngIf="storeViewData.storeAssignment.afterExecutionImageUrl">
                <h4>After Execution</h4>
                <div class="image-container">
                    <div class="image-loading" *ngIf="!afterImageLoaded">
                        <l-tail-chase size="40" speed="1" color="#006fcf"></l-tail-chase>
                    </div>
                    <img [src]="storeViewData.storeAssignment.afterExecutionImageUrl" alt="After Execution"
                        (load)="onAfterImageLoad()" (error)="onAfterImageError()" [class.hidden]="!afterImageLoaded"
                        [class.loaded]="afterImageLoaded"
                        (click)="openImageModal(storeViewData.storeAssignment.afterExecutionImageUrl)">
                </div>
                <p class="image-date" *ngIf="storeViewData.storeAssignment.afterExecutionDate">
                    {{ formatDateOnly(storeViewData.storeAssignment.afterExecutionDate) }}
                </p>
            </div>
        </div>
        <div class="board-details"
            *ngIf="storeViewData.storeAssignment.boardWidth && storeViewData.storeAssignment.boardHeight">
            <h4>Board Specifications</h4>
            <p>{{ storeViewData.storeAssignment.boardWidth }}cm √ó {{ storeViewData.storeAssignment.boardHeight }}cm</p>
        </div>
    </div>

    <!-- Vendor Workflow Progress -->
    <div class="workflow-card" *ngIf="storeViewData.vendorWorkflow.length > 0">
        <div class="card-header">
            <h3 class="card-title">Vendor Workflow Progress</h3>
            <div class="progress-info">
                <span class="progress-text">{{ getVendorWorkflowProgress().toFixed(1) }}% Complete</span>
            </div>
        </div>

        <!-- Horizontal Workflow Stages -->
        <div class="horizontal-workflow">
            <div class="workflow-container">
                <div *ngFor="let stage of storeViewData.vendorWorkflow; let i = index" class="workflow-stage-wrapper">
                    <!-- Workflow Stage -->
                    <div class="workflow-stage" [class]="'stage-' + getWorkflowStatusClass(stage.status)">
                        <div class="stage-content">
                            <h4 class="stage-name">{{ stage.stageName }}</h4>
                            <div class="stage-status-badge" [class]="'status-' + getWorkflowStatusColor(stage.status)">
                                {{ stage.status }}
                            </div>
                            <div class="stage-dates-horizontal" *ngIf="stage.startedAt || stage.completedAt">
                                <div class="date-item" *ngIf="stage.startedAt">
                                    <span class="date-icon">‚ñ∂</span>
                                    <span class="date-text">{{ formatDateOnly(stage.startedAt) }}</span>
                                </div>
                                <div class="date-item" *ngIf="stage.completedAt">
                                    <span class="date-icon">‚úì</span>
                                    <span class="date-text">{{ formatDateOnly(stage.completedAt) }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Arrow connector (except for last stage) -->
                    <div class="stage-connector" *ngIf="i < storeViewData.vendorWorkflow.length - 1">
                        <!-- <div class="connector-line"></div> -->
                        <div class="connector-arrow">‚Üí</div>
                    </div>
                </div>
            </div>

            <!-- Stage Comment Section -->
            <div class="workflow-comments" *ngIf="getActiveStageComment()">
                <div class="comment-header">
                    <span class="comment-icon">üí¨</span>
                    <span class="comment-title">Current Stage Comment</span>
                </div>
                <div class="comment-content">
                    {{ getActiveStageComment() }}
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Workflow Progress -->
    <div class="workflow-card" *ngIf="storeViewData.approvalWorkflow.length > 0">
        <div class="card-header">
            <h3 class="card-title">Approval Workflow Progress</h3>
            <div class="progress-info">
                <span class="progress-text">{{ getApprovalWorkflowProgress().toFixed(1) }}% Complete</span>
            </div>
        </div>

        <!-- Horizontal Workflow Stages -->
        <div class="horizontal-workflow">
            <div class="workflow-container">
                <div *ngFor="let stage of storeViewData.approvalWorkflow; let i = index" class="workflow-stage-wrapper">
                    <!-- Workflow Stage -->
                    <div class="workflow-stage" [class]="'stage-' + getWorkflowStatusClass(stage.status)">
                        <div class="stage-content">
                            <h4 class="stage-name">{{ stage.stageName }}</h4>
                            <div class="stage-status-badge" [class]="'status-' + getWorkflowStatusColor(stage.status)">
                                {{ stage.status }}
                            </div>
                            <div class="stage-dates-horizontal" *ngIf="stage.startedAt || stage.completedAt">
                                <div class="date-item" *ngIf="stage.startedAt">
                                    <span class="date-icon">‚ñ∂</span>
                                    <span class="date-text">{{ formatDateOnly(stage.startedAt) }}</span>
                                </div>
                                <div class="date-item" *ngIf="stage.completedAt">
                                    <span class="date-icon">‚úì</span>
                                    <span class="date-text">{{ formatDateOnly(stage.completedAt) }}</span>
                                </div>
                            </div>
                            <div class="stage-assigned-to" *ngIf="stage.assignedToRoleName">
                                <span class="assigned-icon">üë§</span>
                                <span class="assigned-text">{{ stage.assignedToRoleName }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Arrow connector (except for last stage) -->
                    <div class="stage-connector" *ngIf="i < storeViewData.approvalWorkflow.length - 1">
                        <div class="connector-arrow">‚Üí</div>
                    </div>
                </div>
            </div>

            <!-- Stage Comment Section -->
            <div class="workflow-comments" *ngIf="getActiveApprovalStageComment()">
                <div class="comment-header">
                    <span class="comment-icon">üí¨</span>
                    <span class="comment-title">Current Stage Comment</span>
                </div>
                <div class="comment-content">
                    {{ getActiveApprovalStageComment() }}
                </div>
            </div>

            <!-- Approval Actions Section -->
            <div class="approval-actions-section" *ngIf="hasApprovalActions()">
                <div class="actions-header">
                    <span class="actions-icon">‚ö°</span>
                    <span class="actions-title">Available Actions</span>
                </div>
                <div class="actions-content">
                    <ng-container *ngFor="let stage of storeViewData.approvalWorkflow">
                        <div *ngIf="canApproveStage(stage) || canRejectStage(stage)" class="stage-action-item">
                            <div class="action-stage-info">
                                <span class="action-stage-name">{{ stage.stageName }}</span>
                                <span class="action-stage-role">({{ stage.roleName }})</span>
                            </div>
                            <div class="action-buttons">
                                <button *ngIf="canApproveStage(stage)" class="btn btn-success btn-sm"
                                    (click)="approveStage(stage)" title="Approve this stage">
                                    <span class="material-icons">check</span>
                                    Approve
                                </button>
                                <button *ngIf="canRejectStage(stage)" class="btn btn-danger btn-sm"
                                    (click)="rejectStage(stage)" title="Reject this stage">
                                    <span class="material-icons">close</span>
                                    Reject
                                </button>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>

    <!-- Vendor Notes -->
    <div class="notes-card" *ngIf="storeViewData.storeAssignment.vendorNotes">
        <div class="card-header">
            <h3 class="card-title">Vendor Notes</h3>
        </div>
        <div class="notes-content">
            <p>{{ storeViewData.storeAssignment.vendorNotes }}</p>
        </div>
    </div>

    <!-- Visual Workflow -->
    <!-- <div class="workflow-card">
        <div class="card-header">
            <h3 class="card-title">Workflow Overview</h3>
        </div>
        <div class="workflow-visual">
            <div class="workflow-timeline">
                <div *ngFor="let stage of storeViewData.workflowStages" class="timeline-stage">
                    <div class="stage-marker" [class]="'stage-' + stage.workflowName.toLowerCase().replace(' ', '-')">
                        <span class="stage-number">{{ stage.stageOrder }}</span>
                    </div>
                    <div class="stage-info">
                        <h4>{{ stage.stageName }}</h4>
                        <p class="role-name">{{ stage.roleName }}</p>
                        <span class="final-badge" *ngIf="stage.isFinalStage">Final Stage</span>
                    </div>
                </div>
            </div>
        </div>
    </div> -->
</div>

<!-- Loading Spinner -->
<div class="loading-container" *ngIf="loading">
    <div class="loading-spinner"></div>
    <p>Loading store details...</p>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="!loading && !storeViewData">
    <div class="error-content">
        <span class="material-icons error-icon">error_outline</span>
        <h3>Unable to load store details</h3>
        <p>Please try again or contact support if the problem persists.</p>
        <button class="retry-btn" (click)="loadStoreViewData()">Retry</button>
    </div>
</div>

<!-- Image Modal -->
<div class="image-modal-backdrop" *ngIf="showImageModal" (click)="closeImageModal()">
    <div class="image-modal" (click)="$event.stopPropagation()">
        <button class="close-modal-btn" (click)="closeImageModal()" title="Close">
            <span class="material-icons">close</span>
        </button>
        <img [src]="modalImageUrl" alt="Full Image" />
    </div>
</div>