<div class="create-assignment-container">
    <div class="form-card">
        <div class="form-header">
            <h1 class="form-title">Create New Assignment</h1>
            <p class="form-subtitle">Assign outlets to a vendor with a specific workflow</p>
            <button type="button" class="close-btn" (click)="cancel()" title="Close">
                <span class="close-icon">√ó</span>
            </button>
        </div>

        <!-- Global Loading Overlay -->
        <div *ngIf="loading" class="global-loading-overlay">
            <l-tail-chase size="40" speed="1.75" color="#006fcf"></l-tail-chase>
            <p>Loading...</p>
        </div>

        <form class="assignment-form" [formGroup]="assignmentForm" (ngSubmit)="onSubmit()">
            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="section-title">Basic Information</h3>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="assignmentName" class="form-label">Assignment Name *</label>
                        <input type="text" id="assignmentName" name="assignmentName" formControlName="name"
                            class="form-input" placeholder="Enter assignment name">
                        <div class="error-message"
                            *ngIf="assignmentForm.get('name')?.invalid && assignmentForm.get('name')?.touched">
                            Assignment name is required
                        </div>
                    </div>

                    <div class="form-group half-width">
                        <label for="assignmentDescription" class="form-label">Description</label>
                        <input type="text" id="assignmentDescription" name="assignmentDescription"
                            formControlName="description" class="form-input" placeholder="Enter description (optional)">
                    </div>
                </div>
            </div>

            <!-- Vendor and Workflow Selection -->
            <div class="form-section">
                <h3 class="section-title">Vendor & Workflow</h3>

                <div class="form-row">
                    <div class="form-group half-width">
                        <label for="vendorSelect" class="form-label">Select Vendor *</label>
                        <div class="custom-select" [class.open]="vendorDropdownOpen" (click)="toggleVendorDropdown()">
                            <div class="select-display">
                                <span class="select-text" [class.placeholder]="!selectedVendor">
                                    {{ selectedVendor || 'Choose a vendor' }}
                                </span>
                                <span class="select-arrow">
                                    <span class="material-icons">keyboard_arrow_down</span>
                                </span>
                            </div>
                            <div class="select-dropdown" *ngIf="vendorDropdownOpen" (click)="$event.stopPropagation()">
                                <div class="dropdown-option" *ngFor="let vendor of vendors"
                                    [class.selected]="selectedVendorId === vendor.id" (click)="selectVendor(vendor)">
                                    {{ (vendor.firstName && vendor.lastName) ? (vendor.firstName + ' ' +
                                    vendor.lastName) : vendor.email }}
                                </div>
                            </div>
                        </div>
                        <div class="error-message"
                            *ngIf="assignmentForm.get('vendorId')?.invalid && assignmentForm.get('vendorId')?.touched">
                            Vendor is required
                        </div>

                    </div>

                    <div class="form-group half-width">
                        <label for="workflowSelect" class="form-label">Select Workflow *</label>
                        <!-- NOTE: Vendor Workflow is filtered out in the component to prevent brand users from selecting it -->
                        <div class="custom-select" [class.open]="workflowDropdownOpen"
                            (click)="toggleWorkflowDropdown()">
                            <div class="select-display">
                                <span class="select-text" [class.placeholder]="!selectedWorkflow">
                                    {{ selectedWorkflow || 'Choose a workflow' }}
                                </span>
                                <span class="select-arrow">
                                    <span class="material-icons">keyboard_arrow_down</span>
                                </span>
                            </div>
                            <div class="select-dropdown" *ngIf="workflowDropdownOpen"
                                (click)="$event.stopPropagation()">
                                <div class="dropdown-option" *ngFor="let workflow of workflows"
                                    [class.selected]="selectedWorkflowId === workflow.id"
                                    (click)="selectWorkflow(workflow)">
                                    {{ workflow.name }} ({{ workflow.stageCount }} stages)
                                </div>
                            </div>
                        </div>
                        <div class="error-message"
                            *ngIf="assignmentForm.get('workflowDefinitionId')?.invalid && assignmentForm.get('workflowDefinitionId')?.touched">
                            Workflow is required
                        </div>

                    </div>
                </div>
            </div>

            <!-- Store Selection -->
            <div class="form-section">
                <h3 class="section-title">Outlet Selection</h3>

                <!-- Store Selection Interface -->
                <div class="store-selection-section">

                    <!-- Filters -->
                    <div class="filters-container" [formGroup]="filterForm">
                        <div class="filter-header">
                            <span class="filter-icon">üîç</span>
                            <span class="filter-message">Filter outlets based on these criteria</span>
                        </div>

                        <div class="filter-group">
                            <label for="regionFilter" class="form-label">Region Filter</label>
                            <div class="custom-select" [class.open]="regionDropdownOpen"
                                (click)="toggleRegionDropdown()">
                                <div class="select-display">
                                    <span class="select-text" [class.placeholder]="!selectedRegionName">
                                        {{ selectedRegionName || 'All Regions' }}
                                    </span>
                                    <span class="select-arrow">
                                        <span class="material-icons">keyboard_arrow_down</span>
                                    </span>
                                </div>
                                <div class="select-dropdown" *ngIf="regionDropdownOpen"
                                    (click)="$event.stopPropagation()">
                                    <div class="dropdown-option" (click)="selectRegion(null)">
                                        All Regions
                                    </div>
                                    <div class="dropdown-option" *ngFor="let region of regions"
                                        [class.selected]="selectedRegion === region.id" (click)="selectRegion(region)">
                                        {{ region.name }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="filter-group">
                            <label for="cityFilter" class="form-label">City Filter</label>
                            <input type="text" id="cityFilter" name="cityFilter" formControlName="cityFilter"
                                class="form-input" placeholder="Search by City">
                        </div>

                        <div class="filter-group">
                            <label for="daysFilter" class="form-label">Days Since Last Assignment</label>
                            <input type="number" id="daysFilter" name="daysFilter" formControlName="daysFilter"
                                class="form-input" placeholder="Enter days (e.g., 90)" min="1" max="365">
                            <small class="form-help">Leave empty to show all outlets</small>
                        </div>
                    </div>

                    <!-- Store Grid Header -->
                    <div *ngIf="!loading" class="store-selection-content">
                        <div class="store-grid-header">
                            <div class="right-controls">
                                <div class="pagination-info">
                                    Showing {{ startIndex + 1 }}-{{ endIndex }} of {{ totalStores }} outlets
                                </div>
                            </div>
                        </div>



                        <!-- Store Table -->
                        <div class="store-table-container">
                            <table class="store-table">
                                <thead>
                                    <tr>
                                        <th class="checkbox-header">
                                            <label class="checkbox-label">
                                                <input type="checkbox" [checked]="selectAllPages"
                                                    (change)="selectAllStores()">
                                                <span class="checkmark"></span>
                                            </label>
                                        </th>
                                        <th (click)="sortBy('name')" class="sortable-header">
                                            Store Name
                                            <span class="sort-icon">{{ getSortIcon('name') }}</span>
                                        </th>
                                        <th (click)="sortBy('address')" class="sortable-header">
                                            Address
                                            <span class="sort-icon">{{ getSortIcon('address') }}</span>
                                        </th>
                                        <th (click)="sortBy('regionName')" class="sortable-header">
                                            Region
                                            <span class="sort-icon">{{ getSortIcon('regionName') }}</span>
                                        </th>
                                        <th (click)="sortBy('lastAssignmentDate')" class="sortable-header">
                                            Last Assignment Date
                                            <span class="sort-icon">{{ getSortIcon('lastAssignmentDate') }}</span>
                                        </th>
                                        <th (click)="sortBy('lastAssignedBoardType')" class="sortable-header">
                                            Board Type
                                            <span class="sort-icon">{{ getSortIcon('lastAssignedBoardType') }}</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let store of currentPageStores" class="store-row">
                                        <td class="checkbox-cell">
                                            <label class="checkbox-label">
                                                <input type="checkbox" [checked]="isStoreSelected(store.id)"
                                                    (change)="toggleStoreSelection(store.id)">
                                                <span class="checkmark"></span>
                                            </label>
                                        </td>
                                        <td class="store-name">{{ store.name || '-' }}</td>
                                        <td class="store-address">{{ store.address || '-' }}</td>
                                        <td class="store-region">{{ store.regionName || '-' }}</td>
                                        <td class="last-assignment-date">
                                            {{ store.lastAssignmentDate ? (store.lastAssignmentDate | date:'shortDate')
                                            : '-' }}
                                        </td>
                                        <td class="board-type">{{ store.lastAssignedBoardType || '-' }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination" *ngIf="totalPages > 1">
                            <button type="button" class="btn btn-secondary" [disabled]="currentPage === 1"
                                (click)="previousPage()">
                                Previous
                            </button>
                            <span class="page-info">{{ currentPage }} of {{ totalPages }}</span>
                            <button type="button" class="btn btn-secondary" [disabled]="currentPage === totalPages"
                                (click)="nextPage()">
                                Next
                            </button>
                        </div>
                    </div>

                    <!-- Selected Stores Info -->
                    <div class="selected-stores-info" *ngIf="selectedStoreIds.length > 0">
                        <div class="selected-count">
                            {{ selectedStoreIds.length }} store(s) selected
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" (click)="cancel()">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary"
                    [disabled]="assignmentForm.invalid || selectedStoreIds.length === 0 || submitting">
                    <l-tail-chase *ngIf="submitting" size="20" speed="1.75" color="white"></l-tail-chase>
                    <span *ngIf="!submitting">Create Assignment</span>
                    <span *ngIf="submitting">Creating...</span>
                </button>
            </div>
        </form>
    </div>
</div>